---
title: "Exploratory Analysis"
output: html_notebook
---

```{r}
#Required libraries

# Tidyverse for data science and exploration
require(dplyr)
require(tidyr)
require(readr)
require(tibble)
require(stringr)
require(purrr)
require(forcats)
require(rlang)

# enhances tidyverse
require(tidylog) # additional logging
require(magrittr) # additional data pipe syntax


# for reading data in multiple formats
require(readxl)
require(haven)

# visual analysis
require(ggplot2)
require(GGally) # extensions to ggplot
require(gt) # well formatted tables
# client-side interactive publishable graphics
require(plotly)
require(leaflet)
require(crosstalk)
require(htmlwidgets)
# server-side interactive graphics
require(shiny)
require(shinyjs)
# Canned Interactive EDA 
require(ExPanDaR)


```
## Exploring KU Book Processing Charges
```{r  }
# read KU data frame
KUbpc.df <- read_csv("Public Data/openapc-de/data/bpc.csv")

head <- head(KUbpc.df)
view(head)

summarized = summary(KUbpc.df)
view(summarized)

ggplot(data=KUbpc.df, aes(KUbpc.df$institution)) + geom_bar() 

ggplot(data=KUbpc.df, aes(KUbpc.df$euro)) + geom_histogram()

```
## Exploratory Data Analysis
```{r  }

ggplot(data=KUbpc.df) + geom_bar(mapping = aes(x = KUbpc.df$doab))

# Date to Doab
date_doab <- KUbpc.df %>% ggplot(data=KUbpc.df, mapping = aes(x = KUbpc.df$period, colour = KUbpc.df$doab)) + geom_freqpoly(binwidth = 0.1)
ggplotly(date_doab)

# publisher_euro <- KUbpc.df %>% 
# ggplot(data=KUbpc.df, mapping = aes(x = KUbpc.df$publisher, colour = KUbpc.df$euro)) + geom_freqpoly(binwidth = 0.1)

# Institution to Euro
institution_euro <- KUbpc.df %>% ggplot(data=KUbpc.df, mapping = aes(x = KUbpc.df$euro)) + geom_freqpoly(mapping = aes(colour = KUbpc.df$institution), binwidth = 500)

ggplotly(institution_euro)

```
## Exploratory Data Analysis (Cont.)
#### How do the top 25% of publishers divide up charges (in Euro)?
```{r  }

# count(KUbpc.df, publisher, sort = TRUE)
# top_publisher <- data.frame(KUbpc.df)
# 
# top_publisher %>%
#   group_by(top_publisher$publisher) %>%
#   summarize(Count=n()) %>%
#   top_n(10)

# # get names of the species with counts >= 10
# frequent_publishers <- publisher_counts %>%
#     filter(n >= 10) %>%
#     select(publisher_counts$publisher)
# 
# head(frequent_publishers)

# # filter out the less-frequent species
# KUbpc.df <- KUbpc.df %>%
#     filter(KUbpc.df$publisher %in% frequent_publishers$publisher)
# 
# view(KUbpc.df)

publisher_counts <- KUbpc.df %>%
    group_by(publisher) %>%
    tally

sorted_counts = arrange(publisher_counts, desc(n))

total_n = sum(sorted_counts$n)
quarter_n = 0.25 * total_n
new_n = sum(sorted_counts$n[0:6])

sorted_counts %>% filter(n > 24)

# filtered <- filter(KUbpc.df$publisher %in% sorted_counts$publisher)

filtered <- filter(KUbpc.df, KUbpc.df$publisher == 'transcript Verlag' |
                     KUbpc.df$publisher == 'Duke University Press' |
                     KUbpc.df$publisher == 'University of Michigan Press' |
                     KUbpc.df$publisher == 'Manchester University Press' |
                     KUbpc.df$publisher == 'Pluto Press' |
                     KUbpc.df$publisher == 'Liverpool University Press')

head(filtered)

euro_publisher <- filtered %>% 
  ggplot(data=filtered, mapping = aes(x = filtered$publisher, y = filtered$euro), 
         aes(x = filtered$publisher, y = filtered$euro)) + 
  geom_count(aes(color = ..n.., size = after_stat(prop), group = euro)) + 
  scale_size_area(max_size = 10) + 
  guides(color = 'legend') + 
  ylim(0, 9000)

ggplotly(euro_publisher)


```
### Comparison of charges by year and backlist
```{r}
# create faceted plot object
charges.plot <- KUbpc.df %>% ggplot(aes(euro))+geom_histogram(bins=6)+facet_grid(rows=vars(period), cols = vars(backlist_oa))


## Present as Standard plot
 plot(charges.plot)

# this plot will render publicly https://htmlpreview.github.io/?https://github.com/MIT-Informatics/monograph/blob/master/00%20EDA%20Start.nb.html

```
### Interactive charges exploration
```{r}
 ggplotly(charges.plot)
# https://mit-informatics.github.io/monograph/demo.html

```
```
### Interactive Dataset Exploration 
```
```{r}
KUbpc.df %>% ExPanD(df=.       ,title="KU Book Processing Charges",export_nb_option = TRUE)
# ExPanD uses shiny() which works running R locally, but isn't going to work through github. Could publish through shinyapps.io (low usage only), or export  a non-interactive notebook it
# see: https://drmaltman.shinyapps.io/demo/
```

